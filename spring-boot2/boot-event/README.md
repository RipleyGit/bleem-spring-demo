# 事件监听机制(观察者模式)

## 前言
讲述了Spring的事件机制，基本概念，讲述了事件机制的三要素事件、事件发布、事件监听器。如何实现一个事件机制，应用的场景，搭配@Async注解实现异步的操作等等。
## Spring的事件机制的基本概念
Spring的事件机制是Spring框架中的一个重要特性，基于观察者模式实现，它可以实现应用程序中的解耦，提高代码的可维护性和可扩展性。Spring的事件机制包括事件、事件发布、事件监听器等几个基本概念。

其中，事件是一个抽象的概念，它代表着应用程序中的某个动作或状态的发生。事件发布是事件发生的地方，它负责产生事件并通知事件监听器。事件监听器是事件的接收者，它负责处理事件并执行相应的操作。在Spring的事件机制中，事件源和事件监听器之间通过事件进行通信，从而实现了模块之间的解耦。

举个例子：用户修改密码，修改完密码后需要短信通知用户，记录关键性日志，等等其他业务操作。

如下图，就是我们需要调用多个服务来进行实现一个修改密码的功能。
[Drawio](./README.drawio){link-type="drawio"  page="1"}
使用了事件机制后，我们只需要发布一个事件，无需关心其扩展的逻辑，让我们的事件监听器去处理，从而实现了模块之间的解耦。
[Drawio](./README.drawio){link-type="drawio"  page="2"}
## 事件
通过继承ApplicationEvent，实现自定义事件。是对 Java EventObject 的扩展，表示 Spring 的事件，Spring 中的所有事件都要基于其进行扩展。其源码如下。

## Spring的事件机制的应用场景
- 告警操作，比喻钉钉告警，异常告警，可以通过事件机制进行解耦。
- 关键性日志记录和业务埋点，比喻说我们的关键日志需要入库，记录一下操作时间，操作人，变更内容等等，可以通过事件机制进行解耦。
- 性能监控，比喻说一些接口的时长，性能方便的埋点等。可以通过事件机制进行解耦。
- 一切与主业务无关的操作都可以通过这种方式进行解耦，常用的场景大概就上述提到的，而且很多架构的源码都有使用这种机制，如GateWay，Spring等等。

## Spring的事件机制的注意事项
- 对于同一个事件，有多个监听器的时候，注意可以通过@Order注解指定顺序，Order的value值越小，执行的优先级就越高。
- 如果发布事件的方法处于事务中，那么事务会在监听器方法执行完毕之后才提交。事件发布之后就由监听器去处理，而不要影响原有的事务，也就是说希望事务及时提交。我们就可以 @TransactionalEventListener来定义一个监听器。
- 监听器默认是同步执行的，如果我们想实现异步执行，可以搭配@Async注解使用，但是前提条件是你真的懂@Async注解，使用不当会出现问题的。
- 对于同一个事件，有多个监听器的时候，如果出现了异常，后续的监听器就失效了，因为他是把同一个事件的监听器add在一个集合里面循环执行，如果出现异常，需要注意捕获异常处理异常。